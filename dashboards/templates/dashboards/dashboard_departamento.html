{% extends "core/base.html" %}
{% block content %}

<h1 style="text-align: center; margin-bottom: 20px;">Dashboard Departamento</h1>

{% if departamento %}
<h2 style="margin-bottom: 15px;">Panel de {{ departamento.nombre }}</h2>

<p>Total de solicitudes asociadas a las cuadrillas de este departamento: {{ total }}</p>

<div style="height: 20px;"></div>

<form method="get">
    <label for="estado">Filtrar por estado:</label>
    <select name="estado" id="estado" onchange="this.form.submit()">
        <option value="todo" {% if estado_filtro == 'todo' %}selected{% endif %}>Todas</option>
        {% for estado, cantidad in estado_totales.items %}
            <option value="{{ estado }}" {% if estado_filtro == estado %}selected{% endif %}>
                {{ estado }} ({{ cantidad }})
            </option>
        {% endfor %}
    </select>
</form>

<h3>Listado de incidencias ({{ estado_filtro }})</h3>
<table class="table table-bordered table-hover">
    <thead class="table-light">
        <tr>
            <th>ID</th>
            <th>Incidencia</th>
            <th>Estado</th>
            <th>Cuadrilla</th>
            <th>Departamento</th>
            <th>Fecha creación</th>
            <th>Descripción</th>
        </tr>
    </thead>
    <tbody>
        {% for inc in incidencias_filtradas %}
        <tr>
            <td>{{ inc.pk }}</td>
            <td>{{ inc.incidencia.nombre }}</td>
            <td>
                <span class="badge 
                    {% if inc.estado == 'Pendiente' %}bg-warning
                    {% elif inc.estado == 'En Proceso' %}bg-info
                    {% elif inc.estado == 'Completada' %}bg-success
                    {% else %}bg-secondary{% endif %}">
                    {{ inc.estado }}
                </span>
            </td>
            <td>
                {% if inc.cuadrilla %}
                    <strong>{{ inc.cuadrilla.nombre }}</strong>
                {% else %}
                    <em style="color: #999;">Sin asignar</em>
                {% endif %}

                {% if es_encargado %}
                    <br>
                    <button type="button"
                            class="btn btn-success btn-sm mt-1"
                            onclick="abrirModalAsignar({{ inc.pk }}, '{{ inc.cuadrilla.nombre|default:''|escapejs }}')">
                        Cambiar
                    </button>
                {% endif %}
            </td>
            <td>{{ inc.cuadrilla.departamento.nombre|default:"—" }}</td>
            <td>{{ inc.fecha|date:"d/m/Y H:i" }}</td>
            <td>{{ inc.descripcion|default:"Sin descripción"|truncatewords:8 }}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="7" class="text-center text-muted">No hay incidencias para mostrar.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% else %}
<div class="alert alert-danger">
    Tu perfil no está asociado a ninguna dirección. No hay datos para mostrar.
</div>
{% endif %}

{% if es_encargado %}
<div id="modalAsignar" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px;">
            <h4 style="margin: 0;">Asignar Cuadrilla</h4>
            <span onclick="cerrarModal()" style="cursor: pointer; font-size: 1.5em; color: #999;">&times;</span>
        </div>

        <p><strong>ID Incidencia:</strong> <span id="modal-incidencia-id"></span></p>
        <p><strong>Cuadrilla actual:</strong> <span id="modal-cuadrilla-actual"></span></p>

        <form id="formAsignarCuadrilla" method="post">
            {% csrf_token %}
            <select name="cuadrilla_id" required style="width:100%; padding:8px; margin:8px 0; border:1px solid #ccc; border-radius:4px;">
                <option value="">-- Seleccionar cuadrilla --</option>
                {% for cuad in cuadrillas_disponibles %}
                    <option value="{{ cuad.pk }}">{{ cuad.nombre }}</option>
                {% endfor %}
            </select>
            <div style="margin-top:15px; text-align: right;">
                <button type="submit" style="background:#007bff; color:white; padding:8px 16px; border:none; border-radius:4px; cursor:pointer;">
                    Asignar
                </button>
                <button type="button" onclick="cerrarModal()" style="margin-left:8px; padding:8px 16px; background:#6c757d; color:white; border:none; border-radius:4px; cursor:pointer;">
                    Cancelar
                </button>
            </div>
        </form>
    </div>
</div>
{% endif %}

<script>
function abrirModalAsignar(incidenciaId, cuadrillaActual) {
    document.getElementById('modal-incidencia-id').textContent = incidenciaId;
    document.getElementById('modal-cuadrilla-actual').textContent = cuadrillaActual || 'Ninguna';

    const form = document.getElementById('formAsignarCuadrilla');
    form.action = "{% url 'asignar_cuadrilla' 0 %}".replace('0', incidenciaId);

    const select = form.querySelector('select');
    for (let opt of select.options) {
        if (opt.text === cuadrillaActual) {
            opt.selected = true;
            break;
        }
    }

    document.getElementById('modalAsignar').style.display = 'flex';
}

function cerrarModal() {
    document.getElementById('modalAsignar').style.display = 'none';
}

// Cerrar al hacer clic fuera
window.addEventListener('click', function(e) {
    const modal = document.getElementById('modalAsignar');
    if (e.target === modal) cerrarModal();
});
</script>

{% endblock %}