{% extends "core/base.html" %}
{% block body_class %}custom-theme{% endblock %}

{% block content %}
<style>
    @import url('https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css');

    :root {
        --dashboard-primary: #F9B17A;
        --dashboard-primary-hover: #d89361;
        --dashboard-bg: #2D3250;
        --dashboard-surface: #424769;
        --dashboard-muted: #676F9D;
        --dashboard-text: #FFFFFF;
    }

    body {
        background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.05), transparent 30%), radial-gradient(circle at 80% 10%, rgba(255,255,255,0.05), transparent 32%), var(--dashboard-bg) !important;
    }

    .container {
        background: transparent !important;
        box-shadow: none !important;
        padding: 0 !important;
        margin-top: 28px !important;
        max-width: 1200px !important;
    }

    .review-wrapper {
        font-family: 'Segoe UI', 'Poppins', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        color: var(--dashboard-text);
    }

    .review-card {
        background: var(--dashboard-surface);
        border-radius: 24px;
        padding: 26px 30px;
        border: 1px solid rgba(255,255,255,0.06);
        box-shadow: 0 18px 38px rgba(6, 8, 20, 0.45);
        margin-bottom: 18px;
    }

    .review-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        padding-bottom: 14px;
        margin-bottom: 16px;
    }

    .badge-estado {
        background: rgba(249, 177, 122, 0.14);
        color: var(--dashboard-primary);
        border: 1px solid rgba(249, 177, 122, 0.35);
        border-radius: 999px;
        padding: 0.35rem 0.9rem;
        font-weight: 700;
        letter-spacing: 0.05em;
        text-transform: uppercase;
    }

    .meta-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 12px 16px;
    }

    .meta-item {
        background: rgba(255, 255, 255, 0.04);
        border-radius: 14px;
        padding: 12px 14px;
        border: 1px solid rgba(255, 255, 255, 0.06);
    }

    .meta-label {
        display: block;
        font-size: 0.82rem;
        letter-spacing: 0.08em;
        color: var(--dashboard-muted);
        text-transform: uppercase;
        margin-bottom: 6px;
    }

    .meta-value {
        font-weight: 700;
        color: var(--dashboard-text);
    }

    .body-text {
        color: var(--dashboard-muted);
        line-height: 1.6;
    }

    .gallery {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 14px;
    }

    .gallery img, .gallery video {
        width: 100%;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,0.08);
        box-shadow: 0 10px 24px rgba(6, 8, 20, 0.4);
    }

    .btn-primary {
        background-color: var(--dashboard-primary);
        border-color: var(--dashboard-primary);
        color: #2D3250;
        font-weight: 700;
        border-radius: 12px;
        padding: 0.65rem 1.4rem;
    }

    .btn-primary:hover {
        background-color: var(--dashboard-primary-hover);
        border-color: var(--dashboard-primary-hover);
    }

    .btn-outline-light {
        color: var(--dashboard-text);
        border-color: rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        padding: 0.65rem 1.4rem;
    }

    .btn-outline-light:hover {
        background-color: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.45);
    }

    .btn-danger {
        background-color: #d9534f;
        border-color: #d9534f;
        font-weight: 700;
        border-radius: 12px;
        padding: 0.65rem 1.4rem;
    }

    .btn-danger:hover {
        background-color: #c94440;
        border-color: #c94440;
    }

    @media (max-width: 768px) {
        .review-card { padding: 22px 18px; }
        .review-header { flex-direction: column; }
    }
</style>

<div class="review-wrapper">
    <div class="review-card">
        <div class="review-header">
            <div>
                <p class="text-uppercase fw-semibold mb-1" style="letter-spacing:0.12em; color: var(--dashboard-muted);">Revisión de incidencia</p>
                <h3 class="mb-0">Incidencia #{{ incidencia.solicitud_incidencia_id }}</h3>
            </div>
            <span class="badge-estado">{{ incidencia.estado }}</span>
        </div>

        <div class="meta-grid mb-3">
            <div class="meta-item">
                <span class="meta-label">Incidencia</span>
                <span class="meta-value">{{ incidencia.encuesta.tipo_incidencia }}</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">Cuadrilla</span>
                <span class="meta-value">{{ incidencia.cuadrilla.nombre|default:"No asignada" }}</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">Fecha</span>
                <span class="meta-value">{{ incidencia.fecha|date:"d/m/Y H:i" }}</span>
            </div>
        </div>

        <p class="body-text mb-2"><strong class="text-white">Descripción inicial:</strong> {{ incidencia.descripcion }}</p>
    </div>

    {% if respuesta %}
        <div class="review-card">
            <div class="review-header">
                <h4 class="mb-0">Respuesta de la cuadrilla</h4>
                <small class="text-uppercase" style="letter-spacing:0.08em; color: var(--dashboard-muted);">Recibida el {{ respuesta.fecha_respuesta|date:"d/m/Y H:i" }}</small>
            </div>
            <p class="body-text mb-3">{{ respuesta.respuesta }}</p>

            {% if evidencias %}
                <h6 class="text-uppercase mb-2" style="letter-spacing:0.08em; color: var(--dashboard-muted);">Evidencias</h6>
                <div class="gallery">
                    {% for media in evidencias %}
                        {% if media.tipo == "imagen" %}
                            <img src="{{ media.archivo.url }}" alt="Evidencia">
                        {% elif media.tipo == "video" %}
                            <video controls>
                                <source src="{{ media.archivo.url }}" type="video/mp4">
                                Tu navegador no soporta video.
                            </video>
                        {% endif %}
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    {% else %}
        <div class="alert alert-warning">No hay respuesta registrada de la cuadrilla para esta incidencia.</div>
    {% endif %}

    <div class="d-flex flex-wrap gap-2 mt-3">
        <form method="post">
            {% csrf_token %}
            <button type="submit" class="btn btn-primary">Aprobar incidencia</button>
        </form>
        <a href="/dashboards/rechazar_incidencia/{{ incidencia.solicitud_incidencia_id }}/" class="btn btn-danger">Rechazar incidencia</a>
        <a href="{% url 'dashboard_territorial' %}" class="btn btn-outline-light">Volver al dashboard</a>
    </div>
</div>
{% endblock %}
