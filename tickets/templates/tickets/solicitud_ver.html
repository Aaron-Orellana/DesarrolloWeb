{% extends 'core/base.html' %}

{% block content %}
<h4>Detalle de Solicitud de Incidencia</h4>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
{% endif %}

<div class="mb-3">
    <a href="{% url 'solicitud_editar' solicitud.pk %}" class="btn btn-warning btn-sm">Editar</a>
    <a href="{% url 'solicitud_listar' %}" class="btn btn-secondary btn-sm">Volver al listado</a>
</div>

<table class="table table-bordered">
    <tr><th># Solicitud</th><td>{{ solicitud.solicitud_incidencia_id }}</td></tr>
    <tr><th>Encuesta</th><td>{{ solicitud.encuesta.titulo }}</td></tr>
    <tr><th>Tipo de Incidencia</th><td>{{ solicitud.incidencia.nombre }}</td></tr>
    <tr><th>Territorial</th><td>{{ solicitud.territorial.nombre }}</td></tr>
    <tr><th>Vecino</th><td>{{ solicitud.vecino.email }}</td></tr>
    <tr><th>Ubicación</th><td>{{ solicitud.ubicacion.nombre }}</td></tr>
    <tr><th>Cuadrilla Asignada</th><td>
            {% if solicitud.cuadrilla %}
                <span class="badge bg-secondary">{{ solicitud.cuadrilla.nombre }}</span>
            {% else %}
                <span class="text-muted">No asignada</span>
            {% endif %}
        </td>
    </tr>
    <tr><th>Estado Actual</th><td>{{ solicitud.estado }}</td></tr>
    <tr><th>Descripción</th><td>{{ solicitud.descripcion|default:"—" }}</td></tr>
    <tr><th>Fecha de Creación</th><td>{{ solicitud.fecha|date:"d/m/Y H:i" }}</td></tr>
</table>

<hr>

<h5>Historial de Transiciones</h5>

{% if logs %}
    <table class="table table-striped table-sm">
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Usuario</th>
                <th>Rol</th>
                <th>De → A</th>
                <th>Comentario</th>
            </tr>
        </thead>
        <tbody>
            {% for log in logs %}
                <tr>
                    <td>{{ log.fecha|date:"d/m/Y H:i" }}</td>
                    <td>{{ log.profile.user.username }}</td>
                    <td>{{ log.profile.rol.nombre}}</td>
                    <td>{{ log.from_estado }} → {{ log.to_estado}}</td>
                    <td style="white-space: pre-wrap; word-break: break-word;">{{ log.nota|linebreaksbr |default:"—" }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
{% else %}
    <p class="text-muted">No hay registros en el historial de esta solicitud.</p>
{% endif %}

{% endblock %}
