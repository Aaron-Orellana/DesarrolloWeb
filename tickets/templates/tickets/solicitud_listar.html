{% extends "core/list_base.html" %}

{# === TEMA OSCURO ACTIVADO === #}
{% block theme_class %}custom-theme{% endblock %}

{# === TÍTULO === #}
{% block title %}Listado de Solicitudes de Incidencia{% endblock %}

{# === BOTÓN CREAR NUEVO === #}
{% block create_button %}
    <a href="{% url 'solicitud_crear' %}" class="btn btn-primary">
        Crear Nueva Solicitud
    </a>
{% endblock %}

{# === FILTROS MODERNOS Y RESPONSIVOS === #}
{% block filters %}
<form method="get" class="mb-4 row g-3 align-items-end">
    <div class="col-md-4">
        <input type="text" name="q" class="form-control" 
               placeholder="Buscar por encuesta, incidencia o vecino..." 
               value="{{ request.GET.q|default:'' }}">
    </div>

    <div class="col-md-3">
        <select name="estado" class="form-select">
            <option value="">Todos los estados</option>
            <option value="Pendiente" {% if request.GET.estado == "Pendiente" %}selected{% endif %}>Pendiente</option>
            <option value="Derivada" {% if request.GET.estado == "Derivada" %}selected{% endif %}>Derivada</option>
            <option value="En proceso" {% if request.GET.estado == "En proceso" %}selected{% endif %}>En proceso</option>
            <option value="Finalizada" {% if request.GET.estado == "Finalizada" %}selected{% endif %}>Finalizada</option>
            <option value="Aprobada" {% if request.GET.estado == "Aprobada" %}selected{% endif %}>Aprobada</option>
            <option value="Rechazada" {% if request.GET.estado == "Rechazada" %}selected{% endif %}>Rechazada</option>
        </select>
    </div>

    <div class="col-md-2">
        <input type="text" name="cuadrilla" class="form-control" 
               placeholder="Cuadrilla" 
               value="{{ request.GET.cuadrilla|default:'' }}">
    </div>

    <div class="col-md-2">
        <input type="date" name="fecha" class="form-control" 
               value="{{ request.GET.fecha|default:'' }}">
    </div>

    <div class="col-md-1">
        <button type="submit" class="btn btn-primary w-100">Filtrar</button>
    </div>
</form>

<div class="mb-4">
    <a href="{% url 'solicitud_listar' %}" class="btn btn-secondary btn-sm">
        Limpiar filtros
    </a>
</div>
{% endblock %}

{# === ENCABEZADOS DE TABLA === #}
{% block headers %}
    <th># ID</th>
    <th>Encuesta</th>
    <th>Tipo Incidencia</th>
    <th>Territorial</th>
    <th>Vecino</th>
    <th>Ubicación</th>
    <th>Cuadrilla</th>
    <th>Estado</th>
    <th>Descripción</th>
    <th>Fecha</th>
    <th style="width: 340px;">Acciones</th>
{% endblock %}

{# === FILAS DE LA TABLA === #}
{% block rows %}
    {% for solicitud in solicitudes %}
        <tr>
            <td><strong>#{{ solicitud.solicitud_incidencia_id }}</strong></td>
            <td class="fw-medium">{{ solicitud.encuesta.titulo }}</td>
            <td>{{ solicitud.incidencia.nombre }}</td>
            <td>{{ solicitud.territorial.nombre }}</td>
            <td style="max-width: 180px; white-space: pre-wrap;">{{ solicitud.vecino|truncatechars:60 }}</td>
            <td>{{ solicitud.ubicacion.nombre }}</td>

            <td>
                {% if solicitud.cuadrilla %}
                    <span class="badge badge-main">{{ solicitud.cuadrilla.nombre }}</span>
                {% else %}
                    <span class="text-muted">— Sin asignar</span>
                {% endif %}
            </td>

            <td>
                {% if solicitud.estado == "Pendiente" %}
                    <span class="status-pill status-pendiente">Pendiente</span>
                {% elif solicitud.estado == "Derivada" %}
                    <span class="status-pill status-proceso">Derivada</span>
                {% elif solicitud.estado == "En proceso" %}
                    <span class="status-pill status-proceso">En Proceso</span>
                {% elif solicitud.estado == "Finalizada" %}
                    <span class="status-pill status-finalizada">Finalizada</span>
                {% elif solicitud.estado == "Aprobada" %}
                    <span class="status-pill status-finalizada">Aprobada</span>
                {% elif solicitud.estado == "Rechazada" %}
                    <span class="badge bg-danger text-white">Rechazada</span>
                {% else %}
                    <span class="badge badge-secondary-custom">{{ solicitud.estado }}</span>
                {% endif %}
            </td>

            <td title="{{ solicitud.descripcion|striptags }}">
                {{ solicitud.descripcion|striptags|truncatechars:50 }}
            </td>

            <td class="text-nowrap">
                <small>{{ solicitud.fecha|date:"d/m/Y H:i" }}</small>
            </td>

            <td class="text-nowrap">
                <a href="{% url 'solicitud_ver' solicitud.solicitud_incidencia_id %}"
                   class="btn btn-sm btn-alt">Ver</a>

                <a href="{% url 'solicitud_editar' solicitud.solicitud_incidencia_id %}"
                   class="btn btn-sm btn-warn">Editar</a>

                <a href="{% url 'multimedia_listar' solicitud.solicitud_incidencia_id %}"
                   class="btn btn-sm btn-info text-white">Multimedia</a>

                <a href="{% url 'multimedia_crear' solicitud.solicitud_incidencia_id %}"
                   class="btn btn-sm btn-success">Subir</a>
            </td>
        </tr>

    {% empty %}
        <tr>
            <td colspan="11" class="text-center py-5">
                <div class="my-4">
                    <h5 class="text-muted">
                        {% if request.GET %}
                            No se encontraron solicitudes con los filtros aplicados.
                        {% else %}
                            No hay solicitudes de incidencia registradas aún.
                        {% endif %}
                    </h5>
                    <a href="{% url 'solicitud_crear' %}" class="btn btn-primary mt-3">
                        Crear la primera solicitud
                    </a>
                </div>
            </td>
        </tr>
    {% endfor %}
{% endblock %}