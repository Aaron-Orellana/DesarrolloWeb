{% extends 'core/base.html' %}

{% block content %}
<h4>Listado Solicitudes de Incidencia</h4>


<form method="get" class="mb-3">
    <input type="text" name="q" placeholder="Buscar por encuesta, incidencia o vecino..." value="{{ request.GET.q }}">

    <select name="estado">
        <option value="">Todos los estados</option>
        
        <option value="Pendiente" {% if request.GET.estado == 'Pendiente' %}selected{% endif %}>Pendiente</option>
        <option value="Derivada" {% if request.GET.estado == 'Derivada' %}selected{% endif %}>Derivada</option>
        <option value="En proceso" {% if request.GET.estado == 'En proceso' %}selected{% endif %}>En proceso</option>
        <option value="Finalizada" {% if request.GET.estado == 'Finalizada' %}selected{% endif %}>Finalizada</option>
        <option value="Aprobada" {% if request.GET.estado == 'Aprobada' %}selected{% endif %}>Aprobada</option>
        <option value="Rechazada" {% if request.GET.estado == 'Rechazada' %}selected{% endif %}>Rechazada</option>
    </select>

    <input type="text" name="cuadrilla" placeholder="Cuadrilla" value="{{ request.GET.cuadrilla }}">

    <label for="fecha">Fecha:</label>
    <input type="date" name="fecha" id="fecha" value="{{ request.GET.fecha }}">

    <button type="submit" class="btn btn-primary">Filtrar</button>
    <a href="{% url 'solicitud_listar' %}" class="btn btn-secondary">Limpiar</a>
</form>

<p><a href="{% url 'solicitud_crear' %}" class="btn btn-success">Crear Nueva Solicitud</a></p>

<div style="overflow-x: auto;">
<table class="table table-striped table-hover table-sm">
    <thead>
        <tr>
            <th># Solicitud</th>
            <th>Encuesta</th>
            <th>Tipo Incidencia</th>
            <th>Territorial</th>
            <th>Vecino</th>
            <th>Ubicación</th>
            <th>Cuadrilla</th>
            <th>Estado</th>
            <th>Descripción</th>
            <th>Fecha</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% if solicitudes %}
            {% for solicitud in solicitudes %}
                <tr>
                    <td>{{ solicitud.solicitud_incidencia_id }}</td>
                    <td>{{ solicitud.encuesta.titulo }}</td>
                    <td>{{ solicitud.incidencia.nombre }}</td>
                    <td>{{ solicitud.territorial.nombre }}</td>
                    <td style="white-space: pre-wrap; max-width: 250px;">{{ solicitud.vecino }}</td>
                    <td>{{ solicitud.ubicacion.nombre }}</td>
                    <td>
                        {% if solicitud.cuadrilla %}
                            <span class="badge bg-secondary">{{ solicitud.cuadrilla.nombre }}</span>
                        {% else %}
                            <span class="text-secondary">—</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if solicitud.estado == 'Recibida' %}
                            <span class="badge bg-success">{{ solicitud.estado }}</span>
                        {% else %}
                            <span class="badge bg-danger">{{ solicitud.estado }}</span>
                        {% endif %}
                    </td>
                    <td title="{{ solicitud.descripcion|striptags|truncatechars:100 }}">{{ solicitud.descripcion|truncatechars:30 }}</td>
                    <td>{{ solicitud.fecha|date:"d/m/Y H:i" }}</td>
                    <td>
                        <a href="{% url 'solicitud_ver' solicitud.solicitud_incidencia_id %}" class="btn btn-sm btn-primary">Ver</a>
                        <a href="{% url 'solicitud_editar' solicitud.solicitud_incidencia_id %}" class="btn btn-sm btn-warning">Editar</a>
                        <a href="{% url 'multimedia_listar' solicitud.solicitud_incidencia_id %}" class="btn btn-sm btn-info">Ver Multimedia</a>
                        <a href="{% url 'multimedia_crear' solicitud.solicitud_incidencia_id %}" class="btn btn-sm btn-success">Subir Multimedia</a>
                    </td>
                </tr>
            {% endfor %}
        {% else %}
            <tr>
                <td colspan="11" class="text-center">No hay solicitudes de incidencia registradas o coincidentes con los filtros.</td>
            </tr>
        {% endif %}
    </tbody>
</table>
</div>

{% if solicitudes.has_other_pages %}
<div class="pagination">
    {% if solicitudes.has_previous %}
        <a href="?page={{ solicitudes.previous_page_number }}&{{ query_string }}" class="btn btn-outline-primary">&laquo; Anterior</a>
    {% endif %}

    {% for num in solicitudes.paginator.page_range %}
        {% if solicitudes.number == num %}
            <span class="btn btn-primary disabled">{{ num }}</span>
        {% else %}
            <a href="?page={{ num }}&{{ query_string }}" class="btn btn-outline-primary">{{ num }}</a>
        {% endif %}
    {% endfor %}

    {% if solicitudes.has_next %}
        <a href="?page={{ solicitudes.next_page_number }}&{{ query_string }}" class="btn btn-outline-primary">Siguiente &raquo;</a>
    {% endif %}
</div>
{% endif %}

{% endblock %}
