{% extends 'core/base.html' %}
{% block content %}
<div class="card p-4">
    <h4>Editar Encuesta: {{ encuesta.titulo }}</h4>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <form method="post">
        {% csrf_token %}

        <h5>Detalles Principales</h5>
        {{ encuesta_form.as_p }}

        <hr>
        <h5>Preguntas Asociadas</h5>

        {{ formset.management_form }}

        <div id="pregunta-form-container">
            {% for form in formset %}
            <div class="pregunta-form mb-3 p-3 border rounded bg-light position-relative">
                <div class="row">
                    <div class="col-md-10">
                        {{ form.nombre.label_tag }}
                        {{ form.nombre }}
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        {{ form.DELETE }}
                        <label for="{{ form.DELETE.id_for_label }}" class="btn btn-danger w-100">Eliminar</label>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- plantilla oculta para nuevas preguntas -->
        <template id="empty-form-template">
            <div class="pregunta-form mb-3 p-3 border rounded bg-light position-relative">
                <div class="row">
                    <div class="col-md-10">
                        {{ formset.empty_form.nombre.label_tag }}
                        {{ formset.empty_form.nombre }}
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        {{ formset.empty_form.DELETE }}
                        <label for="{{ formset.empty_form.DELETE.id_for_label }}" class="btn btn-danger w-100">Eliminar</label>
                    </div>
                </div>
            </div>
        </template>

        <div class="mt-3">
            <button type="button" id="add-pregunta-form" class="btn btn-primary">A√±adir Pregunta</button>
        </div>

        <div class="mt-4">
            <button type="submit" class="btn btn-warning">Guardar Cambios</button>
            <a href="{% url 'encuesta_listar' %}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
</div>

<style>
/* Oculta el checkbox DELETE real */
input[type="checkbox"][name$="-DELETE"] {
    display: none;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const addButton = document.getElementById('add-pregunta-form');
    const formContainer = document.getElementById('pregunta-form-container');
    const totalForms = document.getElementById('id_preguntas-TOTAL_FORMS');
    const emptyFormTemplate = document.getElementById('empty-form-template').innerHTML;

    // ‚ûï A√±adir nueva pregunta
    addButton.addEventListener('click', function() {
        const formIndex = parseInt(totalForms.value);
        const newFormHtml = emptyFormTemplate.replace(/__prefix__/g, formIndex);
        formContainer.insertAdjacentHTML('beforeend', newFormHtml);
        totalForms.value = formIndex + 1;
    });

    // üóëÔ∏è Detectar clic en el label del DELETE
    formContainer.addEventListener('click', function(e) {
        // Si el clic fue sobre el label del DELETE
        if (e.target.matches('label[for^="id_preguntas-"][for$="-DELETE"]')) {
            const label = e.target;
            const checkboxId = label.getAttribute('for');
            const checkbox = document.getElementById(checkboxId);
            if (checkbox) {
                checkbox.checked = true; // ‚úÖ Marca el form como eliminado
                const formDiv = label.closest('.pregunta-form');
                if (formDiv) {
                    formDiv.style.display = 'none'; // Oculta visualmente
                }
            }
        }
    });
});
</script>



{% endblock %}